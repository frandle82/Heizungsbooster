type: vertical-stack
cards:
  - type: custom:button-card
    name: Heizungsbooster
    styles:
      card:
        - background: none
        - color: tranparent
        - margin-bottom: 6px
      name:
        - font-family: Segoe UI,Roboto,Helvetica,Arial
        - text-align: start
        - justify-self: start
        - font-weight: 1000
        - font-size: 22px
  - type: custom:button-card
    entity: select.heizungsbooster_betriebsmodus
    show_icon: false
    show_name: false
    show_state: false
    styles:
      card:
        - background-color: rgba(255,255,255,0.08)
        - border-radius: 999px
        - padding: 4px
        - box-shadow: none
      grid:
        - grid-template-areas: "\"aus manuell auto\""
        - grid-template-columns: 1fr 1fr 1fr
        - grid-template-rows: auto
    custom_fields:
      aus:
        card:
          type: custom:button-card
          name: AUS
          hold_action: none
          double_tap_action: none
          tap_action:
            action: call-service
            service: select.select_option
            service_data:
              entity_id: select.heizungsbooster_betriebsmodus
              option: "off"
          styles:
            card:
              - background-color: |
                  [[[
                    return entity.state === 'off'
                    ? '#8b93a7'
                    : 'transparent';
                  ]]]
              - color: |
                  [[[
                    return entity.state === 'off'
                      ? '#0b1a14'
                      : 'rgba(255,255,255,0.78)';
                  ]]]
              - border-radius: 999px
              - font-weight: 600
              - box-shadow: none
              - padding: 10px 14px
              - font-size: 13px
              - font-weight: 750
      manuell:
        card:
          type: custom:button-card
          name: MANUELL
          hold_action: none
          double_tap_action: none
          tap_action:
            action: call-service
            service: select.select_option
            service_data:
              entity_id: select.heizungsbooster_betriebsmodus
              option: manual
          styles:
            card:
              - background-color: |
                  [[[
                    return entity.state === 'manual'
                      ? '#4aa3ff'
                      : 'transparent';
                  ]]]
              - color: |
                  [[[
                    return entity.state === 'manual'
                      ? '#0b1a14'
                      : 'rgba(255,255,255,0.78)';
                  ]]]
              - border-radius: 999px
              - font-weight: 600
              - box-shadow: none
              - padding: 10px 14px
              - font-size: 13px
              - font-weight: 750
      auto:
        card:
          type: custom:button-card
          name: AUTO
          hold_action: none
          double_tap_action: none
          tap_action:
            action: call-service
            service: select.select_option
            service_data:
              entity_id: select.heizungsbooster_betriebsmodus
              option: auto
          styles:
            card:
              - background-color: |
                  [[[
                    return entity.state === 'auto'
                      ? '#2ee59d'
                      : 'transparent';
                  ]]]
              - color: |
                  [[[
                    return entity.state === 'auto'
                      ? '#0b1a14'
                      : 'rgba(255,255,255,0.78)';
                  ]]]
              - border-radius: 999px
              - font-weight: 600
              - box-shadow: none
              - padding: 10px 14px
              - font-size: 13px
              - font-weight: 750
  - type: custom:button-card
    entity: select.heizungsbooster_betriebsmodus
    show_icon: false
    show_name: false
    show_state: false
    styles:
      card:
        - background-color: |
            [[[
              const numState = (id) => {
                const v = Number.parseFloat(states[id]?.state);
                return Number.isFinite(v) ? v : NaN;
              };

              const numAttr = (id, attr) => {
                const v = Number.parseFloat(states[id]?.attributes?.[attr]);
                return Number.isFinite(v) ? v : NaN;
              };

              const deltaColor = (delta) => {
                if (!Number.isFinite(delta)) return 'rgba(255,255,255,.25)';
                if (delta >= 0) return '#2ee59d';
                if (delta <= -1.5) return '#ff5d5d';
                if (delta <= -0.5) return '#ffd166';
                return '#2ee59d';
              };

              const room = numState('sensor.wohnzimmer_temp_temperature');
              const setp = numAttr('climate.wohnzimmer', 'temperature');
              const delta = Number.isFinite(room) && Number.isFinite(setp)
                ? (room - setp)
                : NaN;

              const mode = states['select.heizungsbooster_betriebsmodus']?.state;
              if (mode === 'off') return '#8b93a7';      // --off
              if (mode === 'manual') return '#4aa3ff';   // --manual
              return deltaColor(delta);                          // --auto
            ]]]
        - border-radius: 22px
        - box-shadow: 0 18px 45px rgba(0,0,0,0.45)
        - padding: 14px
        - color: "#071018"
      grid:
        - grid-template-areas: |
            "label"
            "mode"
            "lines"
        - row-gap: 10px
      custom_fields:
        label:
          - justify-self: start
          - grid-area: label
          - font-size: 12px
          - color: rgba(7,16,24,0.65)
        mode:
          - justify-self: start
          - font-size: 22px
          - font-weight: 900
          - line-height: 1.1
          - color: "#071018"
        lines:
          - justify-self: start
          - text-align: start
          - font-size: 14px
          - font-weight: 600
          - line-height: 1.25
          - color: rgba(7,16,24,0.78)
    custom_fields:
      label: Status
      mode: |
        [[[
            const raw = states['select.heizungsbooster_betriebsmodus']?.state;
            if (raw === 'off') return 'Modus: AUS';
            if (raw === 'manual') return 'Modus: MANUELL';
            if (raw === 'auto') return 'Modus: AUTO';
            return 'Modus: —';
          ]]]
      lines: |
        [[[
          const getState = (ids) => {
            for (const id of ids) {
              const value = states[id]?.state;
              if (value !== undefined) return value;
            }
            return undefined;
          };

          const numState = (id) => {
            const v = Number.parseFloat(states[id]?.state);
            return Number.isFinite(v) ? v : NaN;
          };

          const numAttr = (id, attr) => {
            const v = Number.parseFloat(states[id]?.attributes?.[attr]);
            return Number.isFinite(v) ? v : NaN;
          };

          const numFromIds = (ids) => {
            const v = Number.parseFloat(getState(ids));
            return Number.isFinite(v) ? v : NaN;
          };

          const fmt1 = (x) => (Number.isFinite(x) ? x.toFixed(1) : '—');

          const updateHistory = (history, value, now, minDelta, maxLen = 30) => {
            if (!Number.isFinite(value)) return;
            if (history.length) {
              const last = history[history.length - 1];
              const stale = now - last.t > 45000;
              if (Math.abs(value - last.v) < minDelta && !stale) return;
            }
            history.push({ t: now, v: value });
            if (history.length > maxLen) history.shift();
          };

          const historyIsUnstable = (tempHistory, fanHistory) => {
            const now = Date.now();
            let unstableTemp = false;
            let unstableFan = false;

            for (let i = Math.max(1, tempHistory.length - 5); i < tempHistory.length; i++) {
              const prevTemp = tempHistory[i - 1];
              const currTemp = tempHistory[i];
              if (currTemp.t - prevTemp.t < 120000 && Math.abs(currTemp.v - prevTemp.v) > 0.4) {
                unstableTemp = true;
                break;
              }
            }

            for (let j = Math.max(1, fanHistory.length - 5); j < fanHistory.length; j++) {
              const prevFan = fanHistory[j - 1];
              const currFan = fanHistory[j];
              if (currFan.t - prevFan.t < 120000 && Math.abs(currFan.v - prevFan.v) > 25) {
                unstableFan = true;
                break;
              }
            }

            if (!tempHistory.length || now - tempHistory[tempHistory.length - 1].t > 240000) {
              unstableTemp = true;
            }

            return unstableTemp || unstableFan;
          };

          const room = numState('sensor.wohnzimmer_temp_temperature');
          const setp = numAttr('climate.wohnzimmer', 'temperature');
          const fan = numAttr('fan.heizungsbooster_ventilator', 'percentage');
          const heater = numFromIds([
            'sensor.heizungsbooster_heizungstemperatur',
            'sensor.heizungsbooster_heater_temp'
          ]);
          const proxy = numFromIds([
            'sensor.heizungsbooster_heizung_konvektions_proxy',
            'sensor.heizungsbooster_proxy_temp'
          ]);

          const mode = states['select.heizungsbooster_betriebsmodus']?.state;

          const hb = window._hb || (window._hb = {});
          const history = hb.history || (hb.history = {
            temp: [],
            heater: [],
            setp: [],
            fan: [],
            lastUpdate: 0
          });

          const now = Date.now();
          if (!history.lastUpdate || now - history.lastUpdate > 1000) {
            updateHistory(history.temp, room, now, 0.05);
            updateHistory(history.setp, setp, now, 0.05);
            updateHistory(history.fan, fan, now, 1);

            const heaterValue = Number.isFinite(heater) ? heater : proxy;
            updateHistory(history.heater, heaterValue, now, 0.1);
            history.lastUpdate = now;
          }

          const hasTemp = Number.isFinite(room) && Number.isFinite(setp);
          const hasFan = Number.isFinite(fan);
          const unstable = historyIsUnstable(history.temp, history.fan);
          const delta = hasTemp ? (room - setp) : NaN;

          const statusLines = [];
          statusLines.push(
            hasTemp
              ? `Zieltemperatur: ${fmt1(setp)} °C`
              : 'Zieltemperatur: —'
          );

          let nextText = '';
          if (mode === 'off') {
            nextText = 'System deaktiviert – keine aktive Regelung';
          } else if (!hasTemp || !hasFan) {
            nextText = 'Keine verlässliche Aussage möglich';
          } else if (unstable) {
            nextText = 'Regelung passt sich aktuell an';
          } else if (Math.abs(delta) < 0.2) {
             nextText = 'Temperatur im Zielbereich – stabil';
          } else if (delta < -0.2) {
            nextText = 'Ziel wird weiter angefahren';
          } else if (delta > 0.2) {
            nextText = 'Lüfterleistung wird als Nächstes reduziert';
          } else {
            nextText = 'System stabil – keine Anpassung geplant';
          }

          if (nextText) statusLines.push(nextText);
          return statusLines.map(line => `<div>${line}</div>`).join('');
        ]]]
  - type: custom:button-card
    show_icon: false
    show_name: false
    show_state: false
    color_type: card
    styles:
      card:
        - background: rgba(255,255,255,0.06)
        - border-radius: 22px
        - box-shadow: 0 18px 45px rgba(0,0,0,0.45)
        - padding: 14px
        - color: rgba(255,255,255,0.94)
        - display: |
            [[[
              return states['select.heizungsbooster_betriebsmodus']?.state === 'off'
                ? 'none'
                : 'block';
            ]]]
      grid:
        - grid-template-areas: |
            "label"
            "delta"
            "eta"
        - row-gap: 10px
      custom_fields:
        label:
          - justify-self: start
          - font-size: 12px
          - color: rgba(255,255,255,0.65)
        delta:
          - justify-self: start
          - font-size: 26px
          - font-weight: 900
          - line-height: 1.1
          - color: |
              [[[
                const deltaColor = (delta) => {
                  if (!Number.isFinite(delta)) return 'rgba(255,255,255,.25)';
                  if (delta >= 0) return '#2ee59d';
                  if (delta <= -1.5) return '#ff5d5d';
                  if (delta <= -0.5) return '#ffd166';
                  return '#2ee59d';
                };

                const room = Number.parseFloat(
                  states['sensor.wohnzimmer_temp_temperature']?.state
                );
                const setp = Number.parseFloat(
                  states['climate.wohnzimmer']?.attributes?.temperature
                );
                const delta = Number.isFinite(room) && Number.isFinite(setp)
                  ? (room - setp)
                  : NaN;
                return deltaColor(delta);
              ]]]
        eta:
          - justify-self: start
          - font-size: 14px
          - font-size: 14px
          - color: rgba(255,255,255,0.65)
          - color: |
              [[[
                const deltaColor = (delta) => {
                  if (!Number.isFinite(delta)) return 'rgba(255,255,255,.25)';
                  if (delta >= 0) return '#2ee59d';
                  if (delta <= -1.5) return '#ff5d5d';
                  if (delta <= -0.5) return '#ffd166';
                  return '#2ee59d';
                };

                const room = Number.parseFloat(
                  states['sensor.wohnzimmer_temp_temperature']?.state
                );
                const setp = Number.parseFloat(
                  states['climate.wohnzimmer']?.attributes?.temperature
                );
                const delta = Number.isFinite(room) && Number.isFinite(setp)
                  ? (room - setp)
                  : NaN;
                return deltaColor(delta);
              ]]]
    custom_fields:
      label: Zielabweichung
      delta: |
        [[[
          const room = Number.parseFloat(
            states['sensor.wohnzimmer_temp_temperature']?.state
          );
          const setp = Number.parseFloat(
            states['climate.wohnzimmer']?.attributes?.temperature
          );
          const delta = Number.isFinite(room) && Number.isFinite(setp)
            ? (room - setp)
            : NaN;
          const fmtSigned = (value) => {
            if (!Number.isFinite(value)) return '—';
            const sign = value > 0 ? '+' : '';
            return `${sign}${value.toFixed(1)}`;
          };
          return `${fmtSigned(delta)} °C`;
        ]]]
      eta: |
        [[[
          const getState = (ids) => {
            for (const id of ids) {
              const value = states[id]?.state;
              if (value !== undefined) return value;
            }
            return undefined;
          };

          const numState = (id) => {
            const v = Number.parseFloat(states[id]?.state);
            return Number.isFinite(v) ? v : NaN;
          };

          const numAttr = (id, attr) => {
            const v = Number.parseFloat(states[id]?.attributes?.[attr]);
            return Number.isFinite(v) ? v : NaN;
          };

          const numFromIds = (ids) => {
            const v = Number.parseFloat(getState(ids));
            return Number.isFinite(v) ? v : NaN;
          };

          const clamp = (value, min, max) => Math.min(max, Math.max(min, value));

          const fmtMinutes = (value) => {
            if (!Number.isFinite(value)) return '—';
            return Math.max(0, Math.round(value));
          };

          const updateHistory = (history, value, now, minDelta, maxLen = 30) => {
            if (!Number.isFinite(value)) return;
            if (history.length) {
              const last = history[history.length - 1];
              const stale = now - last.t > 45000;
              if (Math.abs(value - last.v) < minDelta && !stale) return;
            }
          history.push({ t: now, v: value });
            if (history.length > maxLen) history.shift();
          };

          const heaterIsRising = (history) => {
            if (history.length < 2) return false;
            const last = history[history.length - 1];
            const prev = history[history.length - 2];
            return last.v > prev.v;
          };

          const historyIsUnstable = (tempHistory, fanHistory) => {
            const now = Date.now();
            let unstableTemp = false;
            let unstableFan = false;

            for (let i = Math.max(1, tempHistory.length - 5); i < tempHistory.length; i++) {
              const prevTemp = tempHistory[i - 1];
              const currTemp = tempHistory[i];
              if (currTemp.t - prevTemp.t < 120000 && Math.abs(currTemp.v - prevTemp.v) > 0.4) {
                unstableTemp = true;
                break;
              }
            }

            for (let j = Math.max(1, fanHistory.length - 5); j < fanHistory.length; j++) {
              const prevFan = fanHistory[j - 1];
              const currFan = fanHistory[j];
              if (currFan.t - prevFan.t < 120000 && Math.abs(currFan.v - prevFan.v) > 25) {
                unstableFan = true;
                break;
              }
            }

           if (!tempHistory.length || now - tempHistory[tempHistory.length - 1].t > 240000) {
              unstableTemp = true;
            }

            return unstableTemp || unstableFan;
          };

          const computeEffectiveRate = (roomHistory, heaterHistory, fan) => {
            if (roomHistory.length < 2) return NaN;
            const first = roomHistory[0];
            const last = roomHistory[roomHistory.length - 1];
            const dt = (last.t - first.t) / 60000;
            if (dt <= 0) return NaN;
            const rateRoom = (last.v - first.v) / dt;
            const heaterTemp = heaterHistory.length
              ? heaterHistory[heaterHistory.length - 1].v
              : NaN;
            const heatSupport = Number.isFinite(heaterTemp)
              ? clamp((heaterTemp - last.v) / 20, 0, 1)
              : 0;
            const fanFactor = 0.5 + (Number.isFinite(fan) ? fan : 0) / 200;
            return rateRoom * fanFactor * (1 + heatSupport);
          };

          const estimateETA = (room, setp, rate) => {
            if (!Number.isFinite(rate) || rate <= 0) return NaN;
            const remaining = setp - room;
            if (remaining <= 0) return 0;
            return remaining / rate;
          };

          const room = numState('sensor.wohnzimmer_temp_temperature');
          const setp = numAttr('climate.wohnzimmer', 'temperature');
          const fan = numAttr('fan.heizungsbooster_ventilator', 'percentage');
          const heater = numFromIds([
            'sensor.heizungsbooster_heizungstemperatur',
            'sensor.heizungsbooster_heater_temp'
          ]);
          const proxy = numFromIds([
            'sensor.heizungsbooster_heizung_konvektions_proxy',
            'sensor.heizungsbooster_proxy_temp'
          ]);
          const mode = states['select.heizungsbooster_betriebsmodus']?.state;

          const hb = window._hb || (window._hb = {});
          const history = hb.history || (hb.history = {
            temp: [],
            heater: [],
            setp: [],
            fan: [],
            lastUpdate: 0
          });

          const now = Date.now();
          if (!history.lastUpdate || now - history.lastUpdate > 1000) {
            updateHistory(history.temp, room, now, 0.05);
            updateHistory(history.setp, setp, now, 0.05);
            updateHistory(history.fan, fan, now, 1);

            const heaterValue = Number.isFinite(heater) ? heater : proxy;
            updateHistory(history.heater, heaterValue, now, 0.1);
            history.lastUpdate = now;
          }

          const hasTemp = Number.isFinite(room) && Number.isFinite(setp);
          const hasFan = Number.isFinite(fan);
          const unstable = historyIsUnstable(history.temp, history.fan);
          const delta = hasTemp ? (room - setp) : NaN;

          let etaText = '';
          if (mode === 'off') {
            etaText = 'Keine ETA berechenbar';
          } else if (!hasTemp) {
            etaText = 'Keine ETA berechenbar';
          } else if (unstable) {
            etaText = 'Warte auf stabile Messwerte';
          } else if (mode !== 'auto') {
            etaText = 'Keine ETA berechenbar';
          } else if (!Number.isFinite(delta) || delta >= -0.2) {
            etaText = 'Keine ETA berechenbar';
          } else if (!hasFan || fan === 0) {
            etaText = 'Keine ETA berechenbar';
          } else {
            const heaterTemp = history.heater.length
              ? history.heater[history.heater.length - 1].v
              : NaN;
            const heaterRising = heaterIsRising(history.heater);
            const proxyWarm = Number.isFinite(proxy) && Number.isFinite(room)
              ? proxy > room + 0.8
              : false;
            if (Number.isFinite(heaterTemp) && heaterTemp < room) {
              etaText = 'Keine ETA berechenbar';
            } else if (!heaterRising && !proxyWarm) {
              etaText = 'Keine ETA berechenbar';
            } else {
              const effectiveRate = computeEffectiveRate(history.temp, history.heater, fan);
              if (Number.isFinite(effectiveRate) && effectiveRate > 0) {
                const etaMinutes = estimateETA(room, setp, effectiveRate);
                if (Number.isFinite(etaMinutes)) {
                  etaText = `Ziel voraussichtlich in ca. ${fmtMinutes(etaMinutes)} Minuten erreicht`;
                } else {
                  etaText = 'Keine ETA berechenbar';
                }
              } else {
                etaText = 'Keine ETA berechenbar';
              }
            }
          }

          return etaText;
        ]]]
  - type: custom:button-card
    show_icon: false
    show_name: false
    show_state: false
    color_type: card
    styles:
      card:
        - background: rgba(255,255,255,0.06)
        - border-radius: 22px
        - box-shadow: 0 18px 45px rgba(0,0,0,0.45)
        - padding: 14px
      grid:
        - grid-template-areas: |
            "label"
            "pair"
        - row-gap: 10px
      custom_fields:
        label:
          - justify-self: start
          - font-size: 12px
          - color: rgba(255,255,255,0.65)
        pair:
          - justify-self: start
          - text-align: start
          - display: flex
          - flex-direction: column
          - gap: 6px
          - font-size: 16px
          - font-weight: 700
          - line-height: 1.25
          - letter-spacing: 0.01em
          - color: rgba(255,255,255,0.94)
          - font-variant-numeric: tabular-nums
    custom_fields:
      label: Temperaturen
      pair: |
        [[[
          const room = Number.parseFloat(
            states['sensor.wohnzimmer_temp_temperature']?.state
          );
          const setp = Number.parseFloat(
            states['climate.wohnzimmer']?.attributes?.temperature
          );

          const roomText = Number.isFinite(room)
            ? `Raum ${room.toFixed(1)} °C`
            : 'Raum — °C';

          const setpText = Number.isFinite(setp)
            ? `Soll ${setp.toFixed(1)} °C`
            : 'Soll — °C';

          return `
            <span>${roomText}</span>
            <span>${setpText}</span>
          `;
        ]]]
  - type: custom:button-card
    entity: fan.heizungsbooster_ventilator
    show_icon: false
    show_name: false
    show_state: false
    color_type: card
    styles:
      card:
        - background: rgba(255,255,255,0.06)
        - border-radius: 22px
        - box-shadow: 0 18px 45px rgba(0,0,0,0.45)
        - padding: 14px
        - color: rgba(255,255,255,0.94)
      grid:
        - grid-template-areas: |
            "label"
            "value"
            "slider"
        - row-gap: 10px
      custom_fields:
        label:
          - justify-self: start
          - font-size: 12px
          - color: rgba(255,255,255,0.65)
        value:
          - justify-self: start
          - font-size: 24px
          - font-weight: 900
        slider:
          - display: |
              [[[
                return states['select.heizungsbooster_betriebsmodus']?.state === 'manual'
                  ? 'block' : 'none';
              ]]]
          - width: 100%
          - justify-self: stretch
          - grid-column: 1 / -1
    custom_fields:
      label: Lüfter
      value: |
        [[[
          const pct = Number.parseFloat(
            states['fan.heizungsbooster_ventilator']?.attributes?.percentage
          );
          return Number.isFinite(pct) ? `${Math.round(pct)} %` : '— %';
        ]]]
      slider: |
        [[[
          const pct = Number.parseFloat(
            states['fan.heizungsbooster_ventilator']?.attributes?.percentage
          );
          const value = Number.isFinite(pct) ? Math.round(pct) : 0;

          return `
            <div style="width:100%; pointer-events:auto; margin-top:14px;">
              <input
                type="range"
                min="0"
                max="100"
                step="25"
                value="${value}"
                style="
                  width:100%;
                  pointer-events:auto;
                  accent-color:#2ee59d;
                "
                oninput="
                  const v = Math.round(this.value / 25) * 25;
                  this.value = v;
                  hass.callService('fan','set_percentage',{
                    entity_id:'fan.heizungsbooster_ventilator',
                    percentage:v
                  });
                "
              />
              <div style="
                display:flex;
                justify-content:space-between;
                font-size:11px;
                color:rgba(255,255,255,0.65);
                margin-top:6px;
              ">
                <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
              </div>
            </div>
          `;
        ]]]
  - type: custom:expander-card
    expanded: false
    clear: false
    title: Diagnose
    title-card:
      type: custom:button-card
      show_icon: false
      show_name: false
      show_state: false
      styles:
        card:
          - height: 28px
          - background: rgba(255,255,255,0.06)
          - border-radius: 14px
          - box-shadow: none
          - color: rgba(255,255,255,0.65)
          - font-size: 14px
          - letter-spacing: 0.08em
          - padding: 0
          - display: flex
          - align-items: center
          - justify-content: center
      name: DIAGNOSE
    cards:
      - type: custom:button-card
        show_icon: false
        show_name: false
        show_state: false
        styles:
          card:
            - background: rgba(255,255,255,0.05)
            - padding: 10px
            - border-radius: 14px
            - box-shadow: 0 18px 45px rgba(0,0,0,0.45)
            - padding: 14px
            - font-family: >
                ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                "Liberation Mono", "Courier New", monospace
            - font-size: 12px
            - color: rgba(255,255,255,0.65)
          grid:
            - grid-template-areas: |
                "text"
                "chart"
                "legende"
            - row-gap: 12px
        custom_fields:
          text: |
            [[[
              const getState = (ids) => {
                for (const id of ids) {
                  const value = states[id]?.state;
                  if (value !== undefined) return value;
                }
                return undefined;
              };

              const numFromIds = (ids) => {
                const v = Number.parseFloat(getState(ids));
                return Number.isFinite(v) ? v : NaN;
              };

              const fmt1 = (value) => (Number.isFinite(value) ? value.toFixed(1) : '—');
              const fmtSigned = (value) => {
                if (!Number.isFinite(value)) return '—';
                const sign = value > 0 ? '+' : '';
                return `${sign}${value.toFixed(1)}`;
              };

              const heater = numFromIds([
                'sensor.heizungsbooster_heizungstemperatur',
                'sensor.heizungsbooster_heater_temp'
              ]);
              const proxy = numFromIds([
                'sensor.heizungsbooster_heizung_konvektions_proxy',
                'sensor.heizungsbooster_proxy_temp'
              ]);
              const room = Number.parseFloat(
                states['sensor.wohnzimmer_temp_temperature']?.state
              );
              const proxyDiff = Number.isFinite(proxy) && Number.isFinite(room)
                ? (proxy - room)
                : NaN;
              const diagState = getState([
                'sensor.heizungsbooster_k_faktor_anpassung',
                'sensor.k_faktor_anpassung'
              ]) ?? '—';

              return `
              Heizung: ${fmt1(heater)} °C
              Proxy:   ${fmtSigned(proxyDiff)} °C
              Regelzustand: ${diagState}
              `;
            ]]]
          chart:
            card:
              type: custom:apexcharts-card
              graph_span: 6h
              update_interval: 30s
              header:
                show: false
              apex_config:
                chart:
                  background: transparent
                  toolbar:
                    show: false
                grid:
                  borderColor: rgba(255,255,255,0.08)
                stroke:
                  strokeDashArray: 2
                  curve: smooth
                legend:
                  show: false
                xaxis:
                  labels:
                    style:
                      colors: rgba(255,255,255,0.5)
              yaxis:
                - id: temp
                  min: 12
                  max: 28
                  decimals: 1
                  apex_config:
                    labels:
                      style:
                        colors: rgba(255,255,255,0.5)
                - id: fan
                  opposite: true
                  min: 0
                  max: 100
                  decimals: 0
                  apex_config:
                    labels:
                      style:
                        colors: rgba(255,255,255,0.5)
              series:
                - entity: sensor.wohnzimmer_temp_temperature
                  name: Ist-Temp
                  color: "#4aa3ff"
                  yaxis_id: temp
                  type: line
                - entity: climate.wohnzimmer
                  attribute: temperature
                  name: Soll-Temp
                  color: "#2ee59d"
                  yaxis_id: temp
                  type: line
                - entity: fan.heizungsbooster_ventilator
                  attribute: percentage
                  name: Lüfter
                  type: column
                  color: "#ffd166"
                  yaxis_id: fan
          legende:
            card:
              type: custom:button-card
              show_icon: false
              show_name: false
              show_state: false
              styles:
                grid:
                  - grid-template-areas: |
                      "room setp fan . ."
                  - grid-template-columns: 1fr 1fr 1fr 1fr 1fr
                  - grid-template-rows: auto
                card:
                  - background: none
                  - box-shadow: none
                  - padding: 0
                  - margin-top: 8px
                  - display: flex
                  - gap: 12px
                  - font-size: 11px
                  - letter-spacing: 0.02em
                  - color: rgba(255,255,255,0.65)
                custom_fields:
                  room:
                    - color: "#4aa3ff"
                  setp:
                    - color: "#2ee59d"
                  fan:
                    - color: "#ffd166"
              custom_fields:
                room: "- Ist-Temp"
                setp: "- Soll-Temp"
                fan: "- Lüfter"
    animation: true
    expander-card-background: rgba(255,255,255,0.06)
    title-card-clickable: false
    title-card-button-overlay: false
